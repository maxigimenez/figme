<dom-module is="figme-list">

    <style>
        .container {
            float: left;
            width: 100%;
        }

        .more {
            float: left;
            width: 100%;
            text-align: center;
            margin: 10px 0;
        }

        .more paper-icon-button {
            color: #FFF;
        }

        .stats {
            max-width: 500px;
            margin: 0 auto;
            border-top: 1px solid #89C6F9;
            padding: 15px 0 0 0;
            color: #FFF;
            text-transform: uppercase;
            font-size: 15px;
            margin-bottom: 20px;
        }

        .stats span {
            font-weight: 700;
        }

        .stats a {
            font-weight: 300;
            color: #FFF;
            text-decoration: none;
        }
    </style>

    <template>

        <iron-ajax
            id="search"
            url="http://api.giphy.com/v1/gifs/search"
            params='{
                "api_key": "dc6zaTOxFJmzC",
                "q": null
            }'
            handle-as="json"
            last-response="{{ items }}"></iron-ajax>

        <template is="dom-if" if="{{ items.data }}">
            <div class="stats">
                Total: <span>[[ items.pagination.total_count ]]</span> - <a href="#" on-tap="clear">Clear</a>
            </div>
        </template>

        <div class="container">
            <template is="dom-repeat" items="{{ results }}">
                <figme-item item="{{ item }}"></figme-item>
            </template>
        </div>

        <template is="dom-if" if="{{ ifMore }}">
            <div class="more">
                <paper-icon-button icon="hardware:keyboard-arrow-down" on-tap="more"></paper-icon-button>
            </div>
        </template>

        <paper-toast id="copied" text="Copied!"></paper-toast>

    </template>

    <script>
        Polymer({
            is: 'figme-list',
            properties: {
                items: {
                    type: Object,
                    observer: '_itemsHasChanged'
                },
                query: {
                    type: String
                },
                ifMore: {
                    type: Boolean,
                    value: false
                },
                offset: {
                    type: Number,
                    value: 0
                },
                results: {
                    type: Array,
                    value: []
                }
            },
            ready: function () {
                this._attachClipboard();
            },
            request: function(getMore) {
                if (!getMore) {
                    this.results = [];
                    this.offset = 0;
                }
                this.$.search.params.offset = this.offset;
                this.$.search.params.q = this.query;
                this.$.search.generateRequest();
            },
            clear: function(event) {
                if (event) {
                    event.preventDefault();
                }
                this.items = {};
                this.offset = 0;
            },
            more: function() {
                this.offset += 25;
                this.request(true);
            },
            _itemsHasChanged: function(value) {
                if ( typeof value.data === 'undefined' ) {
                    this.results = [];
                    this.ifMore = false;
                } else {
                    this.results = this.results.concat(value.data);
                    this.ifMore = value.pagination.total_count > this.results.length;
                }
            },
            _attachClipboard: function() {
                new Clipboard('paper-icon-button.clipboard', {
                    text: function (trigger) {
                        var item = trigger.parentElement.parentElement.parentElement.item;
                        return trigger.id === 'code' ? item.markdown : item.images.original.url;
                    }
                })
                .on('success', function() {
                    this.$.copied.show();
                }.bind(this));
            }
        });
    </script>

</dom-module>
